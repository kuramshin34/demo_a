= MergeRecord 2.2.0

Этот процессор объединяет несколько записно-ориентированных FlowFiles в один FlowFile, содержащий все записи из входных FlowFiles. Этот процессор работает путем создания 'контейнеров' и добавления FlowFiles в эти контейнеры до их заполнения. Как только контейнер заполнен, все FlowFiles будут объединены в один выходной FlowFile, который будет направлен в Relationship 'merged'. Контейнер будет состоять из потенциально множества 'похожих FlowFiles'. Для того чтобы два FlowFiles считались 'похожими', они должны иметь одинаковую схему (определяется Record Reader) и, если установлено свойство <Correlation Attribute Name>, одинаковое значение для указанного атрибута.

[horizontal]
*Tags* (Ключевые слова):
content, correlation, event, merge, record, stream
[horizontal]
*Input Requirement* (Требования к вводу данных):
REQUIRED
[horizontal]
*Supports Sensitive Dynamic* (Поддержка динамически изменяемых параметров, которые могут содержать конфиденциальную информацию):
 False (Нет) 



== Properties (Свойства)


.*Record-Reader*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Record Reader (Записыватель данных)

[horizontal]
*DESCRIPTION (Описание):*:: Указывает сервис контроллера для использования при чтении входящих данных


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.*Record-Writer*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Record Writer (Записыватель записей)

[horizontal]
*DESCRIPTION (Описание):*:: Указывает контроллер сервиса для записи записей


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.*Merge-Strategy*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Merge Strategy (Стратегия слияния)

[horizontal]
*DESCRIPTION (Описание):*:: Указывает алгоритм, используемый для слияния записей. Алгоритм 'Defragment' объединяет фрагменты, ассоциированные по атрибутам, в один целостный FlowFile. Алгоритм 'Bin-Packing Algorithm' создаёт FlowFile, заполненный произвольно выбранными FlowFiles.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*ALLOWABLE VALUES (Допустимые значения):*::

* Bin-Packing Algorithm (Алгоритм упаковки по размеру): Создаёт 'контейнеры' FlowFiles и заполняет каждый контейнер как можно полнее. FlowFiles располагаются в контейнере на основе их размера и, при необходимости, по атрибутам (если установлено свойство <Correlation Attribute>). 

* Defragment (Дефрагментация): Объединяет фрагменты, ассоциированные по атрибутам, в один целостный FlowFile. Если используется эта стратегия, все FlowFiles должны иметь атрибуты <fragment.identifier> и <fragment.count>. Все FlowFiles с одинаковым значением "fragment.identifier" будут сгруппированы вместе. В группе все FlowFiles должны иметь одинаковое значение атрибута "fragment.count". Порядок выходных записей не гарантируется. 


[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.Correlation-Attribute-Name
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Correlation Attribute Name (Корреляционное Имя Атрибута)

[horizontal]
*DESCRIPTION (Описание):*:: Если указано, два FlowFiles будут связаны только в том случае, если они имеют одинаковое значение для этого атрибута. Если не указано, FlowFiles группируются по порядку их извлечения из очереди.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  False (Нет) 
************************************************
.*Attribute Strategy*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Attribute Strategy (Стратегия атрибутов)

[horizontal]
*DESCRIPTION (Описание):*:: Определяет, какие атрибуты FlowFile следует добавить в пакет. Если выбран параметр 'Keep All Unique Attributes', любые атрибуты на любом FlowFile, которые будут включены в пакет, будут сохранены, если их значение не конфликтует с другим значением. Если выбран параметр 'Keep Only Common Attributes', то будут сохраняться только те атрибуты, которые существуют на всех FlowFile в пакете, с одинаковым значением.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*ALLOWABLE VALUES (Допустимые значения):*::

* Keep Only Common Attributes (Сохранять только общие атрибуты): Любой атрибут, который не одинаков на всех FlowFile в бине, будет удален. Те же самые атрибуты, существующие на всех FlowFile, будут сохранены. 

* Keep All Unique Attributes (Сохранять все уникальные атрибуты): Любой атрибут с одинаковым значением для всех FlowFile в бине, или без значения для определенного FlowFile, будет сохранен. Например, если пакет состоит из 3 FlowFile и 2 из них имеют значение 'hello' для атрибута 'greeting', а третий FlowFile не имеет атрибута 'greeting', то исходящий FlowFile получит атрибут 'greeting' со значением 'hello'. 


[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.*Min-Records*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Minimum Number of Records (Минимальное количество записей для включения в бин)

[horizontal]
*DESCRIPTION (Описание):*:: The minimum number of records to include in a bin (Минимальное количество записей, которые необходимо включить в бин)


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: 
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.Max-Records
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Maximum Number of Records (Максимальное количество записей)

[horizontal]
*DESCRIPTION (Описание):*:: The maximum number of Records to include in a bin. This is a 'soft limit' in that if a FlowFile is added to a bin, all records in that FlowFile will be added, so this limit may be exceeded by up to the number of records in the last input FlowFile.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Environment variables defined at JVM level and system properties (Переменные окружения, определенные на уровне JVM и системных свойств)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  False (Нет) 
************************************************
.*Min-Bin-Size*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Minimum Bin Size (Минимальный размер бина)

[horizontal]
*DESCRIPTION (Описание):*:: The minimum size of for the bin (Минимальный размер для бина)


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************
.Max-Bin-Size
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Maximum Bin Size (Максимальный размер корзины)

[horizontal]
*DESCRIPTION (Описание):*:: Максимальный размер для пакета. Если не указан, то ограничений нет. Это 'мягкое ограничение', так как если FlowFile добавляется в корзину, все записи в этом FlowFile будут добавлены, поэтому это ограничение может быть превышено на величину, равную количеству байт в последнем входном FlowFile.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  False (Нет) 
************************************************
.Max-Bin-Age
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Max Bin Age (Максимальный возраст бина)

[horizontal]
*DESCRIPTION (Описание):*:: Максимальный возраст бина, который заставит его быть завершенным. Ожидаемый формат - <duration> <time unit>, где <duration> - положительное целое число, а time unit - одно из: seconds (секунды), minutes (минуты), hours (часы)


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  False (Нет) 
************************************************
.*Max.Bin.Count*
************************************************
[horizontal]
*DISPLAY NAME (Отображаемое наименование):*:: Maximum Number of Bins (Максимальное количество бакетов)

[horizontal]
*DESCRIPTION (Описание):*:: Указывает максимальное количество бакетов, которые могут храниться в памяти одновременно. Это число не должно быть меньше максимального количества одновременных потоков для этого процессора, иначе созданные бакеты будут часто содержать только один входящий FlowFile.


[horizontal]
*EXPRESSION LANGUAGE SCOPE (Область видимости языка выражений):*:: Not Supported (Не поддерживается)
[horizontal]
*SENSITIVE (Содержит конфиденциальные данные):*::  False (Нет) 

[horizontal]
*REQUIRED (Обязательный параметр):*::  True (Да) 
************************************************










=== Relationships (Связи)

[cols="1a,2a",options="header",]
|===
|Наименование |Описание

|`failure`
|Если пакет не может быть создан, все FlowFiles, которые должны были использоваться для его создания, будут переданы в failure

|`original`
|FlowFiles, используемые для создания пакета

|`merged`
|FlowFile с объединенными записями

|===



=== Читаемые атрибуты

[cols="1a,2a",options="header",]
|===
|Наименование |Описание

|`fragment.identifier`
|Применимо только если свойство <Merge Strategy> установлено в Defragment. Все FlowFiles с одинаковым значением для этого атрибута будут объединены вместе.

|`fragment.count`
|Применимо только если свойство <Merge Strategy> установлено в Defragment. Этот атрибут должен присутствовать на всех FlowFiles с одинаковым значением для атрибута fragment.identifier. Все FlowFiles в одном пакете должны иметь одинаковое значение для этого атрибута. Значение этого атрибута указывает, сколько FlowFiles следует ожидать в данном пакете.

|===



=== Writes Attributes (Записываемые атрибуты)

[cols="1a,2a",options="header",]
|===
|Наименование |Описание

|`record.count`
|Объединенный FlowFile будет иметь атрибут 'record.count', указывающий количество записей, записанных в FlowFile.

|`mime.type`
|MIME-тип, указанный Record Writer

|`merge.count`
|Количество FlowFiles, объединенных в этот пакет

|`merge.bin.age`
|Возраст контейнера, в миллисекундах, когда он был объединен и выведен. По сути, это максимальное время, в течение которого FlowFile оставался в данном процессоре перед выводом

|`merge.uuid`
|UUID объединенного FlowFile, который будет добавлен к атрибутам исходных FlowFiles

|`merge.completion.reason`
|Этот процессор позволяет настроить несколько пороговых значений для объединения FlowFiles. Этот атрибут указывает, какой из Порогов привел к тому, что FlowFiles были объединены. Для объяснения каждого возможного значения и его значений см. использование/документацию процессора и страницу 'Дополнительные сведения'.

|`<Attributes from Record Writer>`
|Любой атрибут, возвращаемый настроенным Record Writer, будет добавлен к FlowFile.

|===



== Варианты использования
:sectnums:



=== Объединить множество произвольных записей для создания одного большого файла


NOTE: 



Ключевые слова::



.Конфигурация
====
Настройте "Record Reader", чтобы указать подходящий Record Reader для входящего типа данных.
Настройте "Record Writer", чтобы указать подходящий Record Writer для желаемого выходного типа данных.
Установите "Merge Strategy" на `Алгоритм упаковки контейнеров`.
Установите свойство "Минимальный размер контейнера" на желаемый размер файла объединения в выходных данных. Например, значение `1 MB` приведет к тому, что не будет объединяться данные до тех пор, пока не станет доступно не менее 1 МБ (если сначала не достигнут максимальный возраст контейнера).
Если нет другой требовательности к задержке, установите "Максимальный возраст контейнера" на разумное значение по умолчанию, например `10 мин`.

Подключите Relationship 'merged' к следующему компоненту в потоке. Автотерминируйте Relationship 'original'.
====




== Варианты использования, включающие другие компоненты


=== Объединить множество записей, имеющих одинаковое значение для определенного поля в данных, для создания одного большого файла


NOTE: 



Ключевые слова::

merge

combine

aggregate

like records

similar data








=== Смотрите также


* xref:Processors/MergeContent.adoc[MergeContent]

* xref:Processors/PartitionRecord.adoc[PartitionRecord]

* xref:Processors/SplitRecord.adoc[SplitRecord]


